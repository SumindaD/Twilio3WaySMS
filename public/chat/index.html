<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <p id='log'></p>
</head>
<body>
    <input id="chat-input" type="text" placeholder="say anything" autofocus/>

    <script src="https://media.twiliocdn.com/sdk/js/common/v0.1/twilio-common.min.js"></script>
    <script src="https://media.twiliocdn.com/sdk/js/chat/v3.0/twilio-chat.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
        var log = document.getElementById('log');

        $.getJSON('/token', {
            device: 'browser'
        }, function(data) {
            // Initialize the Chat client
            Twilio.Chat.Client.create(data.token).then(client => {
                log.innerHTML +=  '<p>Created chat client</p><br/>';
                chatClient = client;
                chatClient.getSubscribedChannels().then(createOrJoinGeneralChannel);

                // Alert the user they have been assigned a random username
                username = data.identity;

                log.innerHTML += '<p>You have been assigned a random username of: ' + username + '</p><br/>';
            }).catch(error => {
                log.innerHTML += '<p>There was an error creating the chat client:' + error + '</p><br/>';
            });
        });

        function createOrJoinGeneralChannel() {
            // Get the general chat channel, which is where all the messages are
            // sent in this simple application
            log.innerHTML +=  '<p>Attempting to join "general" chat channel...</p><br/>';
            
            chatClient.getChannelByUniqueName('general').then(function(channel) {
                generalChannel = channel;
                log.innerHTML +=  '<p>Found general channel: ' + generalChannel + '</p><br/>';
                setupChannel();
            }).catch(function() {
                // If it doesn't exist, let's create it
                log.innerHTML +=  '<p>Creating general channel </p><br/>';
                chatClient.createChannel({
                    uniqueName: 'general',
                    friendlyName: 'General Chat Channel'
                }).then(function(channel) {
                    log.innerHTML +=  '<p>Created general channel: ' + channel + '</p><br/>';
                    generalChannel = channel;
                    setupChannel();
                }).catch(function(channel) {
                    log.innerHTML +=  '<p>Channel couldn\'t be created: ' + channel + '</p><br/>';
                });
            });
        }

         // Set up channel after it has been found
        function setupChannel() {
            // Join the general channel
            generalChannel.join().then(function(channel) {
                log.innerHTML += '<p>Joined channel as ' + username + '</p><br/>';
            });

            // Listen for new messages sent to the channel
            generalChannel.on('messageAdded', function(message) {
                log.innerHTML += '<p>' + message.author + ' : ' + message.body + '</p><br/>';
            });
        }

        var $input = $('#chat-input');
        $input.on('keydown', function(e) {

            if (e.keyCode == 13) {
                generalChannel.sendMessage($input.val())
                $input.val('');
            }
        });
    </script>
</body>
</html>